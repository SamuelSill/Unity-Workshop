<!DOCTYPE html>
<html>
<head>
  <title>Draw&Drive</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <style>
        body {
        background-size: cover;
        height: 100vh;
        width: 100%;
        background-image: url("Images/backgroundmenu.png");
        background-color: #cccccc;
        background-repeat: no-repeat;
       }
       /* grid container for 2 pedals and staring wheel in the middle */
       .container{
        display:grid;
        grid-template-columns: 1fr 2fr 1fr;
        height: 100%;
        width: 100%;
      

       }

       .leftPedal, .rightPedal{
        background-image: url("Images/reverse.png");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: bottom;
        justify-self: bottom;
        align-self: bottom;
        cursor: pointer;
        height: 50%;
        
         margin-top: auto; 
       }
      .rightPedal{
        background-image: url("Images/pedal.png");
     
       }


       .stairingWheel{
        background-image: url("Images/steeringWheel.png");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        width: 100%;
        height: 100%;
        justify-self: center;
        align-self: center;
        cursor: pointer;
       }
    </style>
</head>
<body >

  <div class="container">
    <div  id="reverse"  class="leftPedal"></div>
    <div class="stairingWheel"></div>
    <div  id="pedal"  class="rightPedal"></div>
  </div>
<!-- 
    <img src="Images/reverse.png" id="reverse" style="position: absolute;
    max-width: 20%;
    height: auto;
    top: 50%;
    left: 10%;
    margin-top: -50px;
    margin-left: -50px;">
    <img src="Images/steeringWheel.png" style="position: absolute;
    max-width: 30%;
    height: auto;
    top: 50%;
    left: 35%;
    margin-top: -50px;
    margin-left: -50px; " >
    <img src="Images/pedal.png" id="pedal" style="position: absolute;
    max-width: 20%;
    height: auto;
    top: 50%;
    left: 70%;
    margin-top: -50px;
    margin-left: -50px;"> -->



<h1 style="color:white;">Gyroscope Data</h1>

  <div id="gyro-data" style="color:white;">
    <p>Gyroscope data:</p>
    <ul>
      <li>Rotation rate alpha: <span id="alpha-value"></span></li>
      <li>Rotation rate beta: <span id="beta-value"></span></li>
      <li>Rotation rate gamma: <span id="gamma-value"></span></li>
    </ul>
  </div>
    <div id="pedal_data" style="color:white;"></div>
    <div id="reverse_data" style="color:white;"></div>
 

  <script>
    const socker_api_url = "wss://unity-https-drawndrive.com";
    var pedal_pressed = false;
    var reverse_pressed = false;
    const intervalSeconds =100; // 5 seconds in milliseconds
    
    //send data to socket
    // message to socket is jason with 3 fields:
    // id ="mobileControl"
    // gyro = {x,y,z}
    // drive = forward/reverse/stop
    

    //--------------------Gyro---------------------------------------------------------
    function startGyroscope() {
      if ('Gyroscope' in window) {
        // Create a new gyroscope sensor instance
        const gyroscope = new Gyroscope();
        gyroscope.frequency = 100;
        // Handle gyroscope reading changes
        gyroscope.addEventListener('reading', handleGyroscopeReading);

        // Start the gyroscope sensor
        gyroscope.start();
      } else {
        alert('Gyroscope is not supported on this device');
      }
    }

    function handleGyroscopeReading(event) {
      // Get the gyroscope readings
      const { x, y, z } = event.target;
      
      // Display the gyroscope data on the webpage
      document.getElementById('alpha-value').textContent = x.toFixed(2);
      document.getElementById('beta-value').textContent = y.toFixed(2);
      document.getElementById('gamma-value').textContent = z.toFixed(2);
    }
    // Request gyroscope permission and start using gyroscope data
    function requestGyroscopePermission() {
      navigator.permissions.query({ name: 'gyroscope' })
        .then((result) => {
          if (result.state === 'granted') {
            startGyroscope();
          } else if (result.state === 'prompt') {
            result.onchange = () => {
              if (result.state === 'granted') {
                startGyroscope();
              }
            };
          } else {
            alert('Gyroscope access denied');
          }
        })
        .catch((error) => {
          console.error('Error requesting gyroscope access:', error);
        });
    }

    // Call the permission request function when the page loads
    window.addEventListener('load', requestGyroscopePermission);
    //---------------------------------------------------------------------------------

    //--------------------Pedal---------------------------------------------------------
    function pedal_press() {
        event.preventDefault();
        document.getElementById("pedal_data").innerHTML = "Drive";//Pedal pressed
        pedal_pressed = true;
    }
    function pedal_release() {
        event.preventDefault();
        document.getElementById("pedal_data").innerHTML = "Stop"; //Pedal released
        pedal_pressed = false;
    }
    document.getElementById("pedal").addEventListener("touchstart", pedal_press);
    document.getElementById("pedal").addEventListener("touchend", pedal_release);
    //---------------------------------------------------------------------------------
    //--------------------Reverse---------------------------------------------------------
    function reverse_press() {
        event.preventDefault();
        document.getElementById("reverse_data").innerHTML = "Mode: Reverse"; //Reverse pressed
        reverse_pressed = true;
    }
    function reverse_release() {
        event.preventDefault();
        document.getElementById("reverse_data").innerHTML = "Mode: Forward";//Reverse released
        reverse_pressed = false;
    }
    document.getElementById("reverse").addEventListener("touchstart", reverse_press);
    document.getElementById("reverse").addEventListener("touchend", reverse_release);
    //---------------------------------------------------------------------------------
    
 


const api_gamecode_request = (gamePin,username,password) =>{
  try{
    const ws_url = (codePin) => `${socker_api_url}/games/ws/${codePin}/${username}/${password}/true`;

    const webHook = ws_url(gamePin);
    console.log(gamePin,webHook);

    var ws = new WebSocket(webHook);

  //--------------------Send data to socket-------------------------------------------
    function send_data_to_socket(){
      var gyro_x = document.getElementById("alpha-value").textContent;
      var gyro_y = document.getElementById("beta-value").textContent;
      var gyro_z = document.getElementById("gamma-value").textContent;
      let drive;
      if (reverse_pressed === pedal_pressed) {
          drive = 'stop';
      } else if (pedal_pressed) {
          drive = 'forward';
      } else {
          drive = 'reverse';
      }
      ws.send(JSON.stringify({id:"MobileControls",gyro:{x:gyro_x,y:gyro_y,z:gyro_z},drive:drive}));
    }
  //---------------------------------------------------------------------------------
    

    ws.addEventListener("error", (event) => { //maybe check if the gamecode exists
      console.log("WebSocket error: ", event);
      window.location.href = 'lobby.html';
    });
          
    ws.onopen = function() {             
    // Web Socket is connected, send data using send()
      console.log("connected");
      setInterval(send_data_to_socket, intervalSeconds);
    };

  
    ws.onmessage = function (evt) { 
      console.log(evt);
      var received_msg = evt.data;
      if(received_msg.JSON["id"] == "ErrorJoining"){
        var message = received_msg.JSON["message"];
        alert(message);
      }
    };
          
    ws.onclose = function() { 
      console.log("closed connection");
      window.location.href = 'lobby.html';
      // websocket is closed.
    };
      
  }
  catch(error){
    console.log(error);
    window.location.href = 'lobby.html';
  } 
}
    // on html load 
    document.addEventListener("DOMContentLoaded", function(event) {
      // get game code from url
      var url_string = window.location.href;
      var url = new URL(url_string);
      var codePin = url.searchParams.get("codePin");
      // get username and password from local storage
      const username= localStorage.getItem("username")
      const password = localStorage.getItem("password")

      api_gamecode_request(codePin,username,password);

    });


  </script>
</body>
</html>
